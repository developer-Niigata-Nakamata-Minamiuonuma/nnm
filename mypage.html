<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>マイページ</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1:wght@600&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'M PLUS 1', sans-serif;
  background: #f2f2f2;
}

/* ===== ヘッダー ===== */
.header {
  background: #bf0000;
  color: #fff;
  padding: 14px 16px;
  display: flex;
  align-items: center;
}

.back {
  margin-right: 12px;
  font-size: 18px;
  cursor: pointer;
}

/* ===== 共通 ===== */
.container {
  padding: 16px;
}

.card {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 16px;
  font-size: 14px;
}

.card-title {
  font-size: 13px;
  color: #666;
  margin-bottom: 10px;
}

.value {
  font-size: 16px;
}

.sub {
  font-size: 12px;
  color: #888;
  margin-top: 4px;
}

/* ===== 名前横並び ===== */
.name-row {
  display: flex;
  gap: 12px;
}

.name-item {
  flex: 1;
}

/* ===== ボタン ===== */
.action-link,
.link-outline {
  display: block;
  text-align: center;
  text-decoration: none;
  padding: 12px;
  border-radius: 10px;
  font-size: 14px;
  margin-top: 10px;
}

.link-outline {
  border: 1px solid #bf0000;
  color: #bf0000;
  background: #fff;
}

/* ===== ユーザーID ===== */
.user-id {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.copy-btn {
  font-size: 12px;
  color: #bf0000;
  border: 1px solid #bf0000;
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- ヘッダー -->
<div class="header">
  <div class="back" onclick="history.back()">←</div>
  <div>マイページ</div>
</div>

<div class="container">

  <!-- 利用者名（横並び） -->
  <div class="card">
    <div class="card-title">ご利用者さま</div>

    <div class="name-row">
      <div class="name-item value" id="db_sei_top">---</div>
      <div class="name-item value" id="db_mei_top">---</div>
    </div>

    <div class="name-row sub">
      <div class="name-item" id="db_seiKana_top">---</div>
      <div class="name-item" id="db_meiKana_top">---</div>
    </div>
  </div>

  <!-- 利用者情報 -->
  <div class="card">
    <div class="card-title">利用者情報</div>

    <div class="name-row">
      <div class="name-item">
        <div class="sub">姓</div>
        <div class="value" id="db_sei">---</div>
      </div>
      <div class="name-item">
        <div class="sub">名</div>
        <div class="value" id="db_mei">---</div>
      </div>
    </div>

    <div class="name-row" style="margin-top:10px;">
      <div class="name-item">
        <div class="sub">姓（カナ）</div>
        <div class="value" id="db_seiKana">---</div>
      </div>
      <div class="name-item">
        <div class="sub">名（カナ）</div>
        <div class="value" id="db_meiKana">---</div>
      </div>
    </div>

    <!-- 住所 -->
    <div style="margin-top:14px;">
      <div class="sub">住所</div>
      <div class="value" id="db_address">---</div>
    </div>

    <!-- 契約プラン -->
    <div style="margin-top:14px;">
      <div class="sub">契約プラン</div>
      <div class="value" id="db_plan">---</div>
    </div>

    <!-- ご利用中オプション -->
    <div style="margin-top:14px;">
      <div class="sub">ご利用中オプション</div>
      <div class="value" id="db_options">---</div>
    </div>

    <!-- Nメールアドレス -->
    <div style="margin-top:14px;">
      <div class="sub">Nメールアドレス</div>
      <div class="value" id="db_nmail">＊＊＊</div>
    </div>

    <!-- 契約書 -->
    <a
      id="db_contractPdf"
      class="link-outline"
      href="#"
      style="margin-top:14px;"
      target="_blank"
      rel="noopener"
    >
      契約書をダウンロード（PDF）
    </a>
  </div>

  <!-- ユーザーID -->
  <div class="card">
    <div class="card-title">ユーザーID</div>
    <div class="user-id">
      <div class="value" id="userId">---</div>
      <div class="copy-btn" onclick="copyUserId()">コピー</div>
    </div>
    <div class="sub">※ ログインやお問い合わせで使用します</div>
  </div>

</div>

<script>
function copyUserId() {
  const text = document.getElementById('userId').textContent;
  navigator.clipboard.writeText(text);
}
</script>

<!-- ★追加：DB読み込み -->
<script src="./api.js"></script>
<script src="./auth.js"></script>

<script>
(async () => {
  const login = requireLoginOrRedirect();
  if (!login) return;

  try {
    const res = await apiMe(login.contractId, login.userId);

    if (!res || !res.ok) {
      logout();
      return;
    }

    const u = res.user || {};

    // 上段の氏名
    setText("db_sei_top", u.sei);
    setText("db_mei_top", u.mei);
    setText("db_seiKana_top", u.seiKana);
    setText("db_meiKana_top", u.meiKana);

    // 利用者情報
    setText("db_sei", u.sei);
    setText("db_mei", u.mei);
    setText("db_seiKana", u.seiKana);
    setText("db_meiKana", u.meiKana);

    // 住所・契約プラン・オプション・Nメール
    setText("db_address", u.address || "---");
    setText("db_plan", u.plan || "---");
    setText("db_options", u.options || "---");
    setText("db_nmail", u.nmail || "＊＊＊");

    // ユーザーID（表示）
    setText("userId", u.userId);

    // 契約書リンク
    const a = document.getElementById("db_contractPdf");
    if (a) {
      if (u.contractPdfUrl) {
        a.href = u.contractPdfUrl;
        a.style.pointerEvents = "auto";
        a.style.opacity = "1";
      } else {
        a.href = "#";
        a.style.pointerEvents = "none";
        a.style.opacity = "0.5";
      }
    }

  } catch (e) {
    console.error(e);
    alert("ユーザー情報の取得に失敗しました");
  }
})();

function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value ?? "";
}
</script>

</body>
</html>
